<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='Please, never say &amp;quot;widgets&amp;quot; in my presence again.' name='description'>
<meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<meta content='True' name='HandheldFriendly'>
<meta content='320' name='MobileOptimized'>
<link href='/favicon.png' rel='icon'>
<title>Awkward and Proud - Joshua Davey</title>
<link href="/stylesheets/screen.css" rel="stylesheet" type="text/css" />
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml" />
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>
<script src='/javascripts/main.js'></script>
</head>
<body>
<div id='content'>
<header>
<h1><a href="/">Awkward and Proud</a></h1>
</header>
<div id='description'>
<ul class='meta'>
<li>
<a href="/about">About</a>
/
<a href="/atom.xml">RSS</a>
</li>
</ul>
</div>
<div id='main'><div class='post'>
<div class='post-body'>
<h2>Faster TDD feedback with tmux, tslime.vim, and turbux.vim</h2>
<p><strong>tl;dr</strong> Developing in a tmux session has sped up my TDD cycle
considerably, especially with the help of tslime.vim and turbux.vim. I
get immediate feedback in one pane, but never have to leave vim or lose
context of what I&rsquo;m working on to see the test result.</p>

<p>Taking a cue from <a title="Robot Has No Heart - Vim and tmux on OSX" href="http://rhnh.net/2011/08/20/vim-and-tmux-on-osx">Xavier Shay&rsquo;s excellent intro to tmux</a>, I&rsquo;ve
been using tmux lately as my primary workspace. There are excellent
<a title="Peter Cooper's introduction to tmux" href="http://peterc.org/blog/2010/216-tmux.html">introductions to</a> <a title="Hawkhost's introduction to tmux" href="http://blog.hawkhost.com/2010/06/28/tmux-the-terminal-multiplexer/">tmux elsewhere</a>, but I&rsquo;ve really
enjoyed the switch from MacVim/Terminal to a single tmux session for
development. But rather than sing tmux&rsquo;s praises, I&rsquo;d like to talk about
how tmux and a vim plugin have changed my testing feedback loop for the
better.</p>

<h2>Other test-running solutions</h2>

<p>Autotesting gives you immediate feedback, but runs everytime you save a
file. Even though this often is desired behavior, I can&rsquo;t tell you how
many times I&rsquo;ve saved a feature file, only to immediately notice a typo.
Especially with Rails project, this can be an expensive amount of time.
I end up feeling punished for saving my work.</p>

<p>I&rsquo;ve also tried more editor-embedding techniques of running tests. Both
<a title="Rails.vim: Ruby on Rails power tools" href="https://github.com/tpope/vim-rails">rails.vim</a> and rake.vim provide facilities for running <code>:Rake</code>. When
combined with a keyboard shortcut, this gets closer to the kind of
control I like to have, running my tests exactly when I want them. The
downside, though, is that I lose control of my editor and have to wait
for the command to finish before I can type, or even navigate again. And
I can&rsquo;t look at a failure message and my code at the same time.</p>

<h2>A faster feedback loop</h2>

<p>A practice that is quickly gaining popularity in the Ruby community is
isolating your business logic from your persistance logic and framework.
Rather than load Rails (or some other large library or framework),
you sequester all business logic in its own class or module, and then
test that class or module in isolation. This has a ton of benefits for
the longevity of your code, but one of the side benefits is the speed
increase for running individual specs or tests. This technique is being
championed by Gary Bernhardt and Corey Haines, among others.</p>

<p>Because tmux is so scriptable, it isn&rsquo;t hard to send commands to other
panes in a tmux session programmatically. Leveraging the power of
<a title="Rails.vim: Ruby on Rails power tools" href="https://github.com/tpope/vim-rails">rails.vim</a> and <a title="Joshua Davey's tslime.vim fork" href="https://github.com/jgdavey/tslime.vim">tslime.vim</a>, I&rsquo;ve created a vim plugin that shortens
the feedback loop when practicing TDD in a tmux session. It&rsquo;s called
<a title="Turbux: turbo Ruby testing with tmux" href="https://github.com/jgdavey/vim-turbux">turbux.vim</a>.</p>

<h2>Using tslime.vim</h2>

<p>My typical workflow now involves setting up a tmux session for my
project, splitting vertically (<code>&lt;C-b&gt; %</code>), and using layout 4 (<code>&lt;C-b&gt;
&lt;Alt-4&gt;</code>). In fullscreen, the result is about 30% for my shell on the
left, and 70% for vim on the right.</p>

<p>The first time you use it, tslime.vim will prompt you to input your tmux
session name, window number, and pane number. There is completion for
each of these prompts, so you can happily mash <code>&lt;Tab&gt;</code>.</p>

<p>The plugin exposes a general-purpose function to send arbitrary text to
the configured tmux pane. For example, you can use it in the following way:</p>
<pre><code class="highlight plaintext">:call Send_to_Tmux("rspec ".expand("%")."\n")
</code></pre>

<p>The above command would send <code>rspec path/to/spec.rb</code> to the configured
pane. For me, this pattern of running the test file that is currently
open is so common that I&rsquo;ve packaged up some useful defaults in
<a title="Turbux: turbo Ruby testing with tmux" href="https://github.com/jgdavey/vim-turbux">turbux.vim</a>.</p>

<h2>Using turbux.vim</h2>

<p>Turbux.vim tries to intelligently choose the right spec, test or feature
to run when you invoke it. If you&rsquo;re in a spec, invoking the plugin
(by default with <code>&lt;leader&gt;t</code>) will run <code>rspec path/to/my_spec.rb</code> in
the corresponding pane. In a test-unit file, it will run <code>ruby -Itest
path/to/test.rb</code>. In a cucumber feature file, it will run <code>cucumber
path/to/my.feature</code>.</p>

<p>Thanks to <a title="Rails.vim: Ruby on Rails power tools" href="https://github.com/tpope/vim-rails">rails.vim</a>&rsquo;s awesomeness, I&rsquo;ve also provided some mappings for
when the current file has a corresponding test or spec. For example,
When I&rsquo;m in a file that has a corresponding spec, such as a model or
controller, the command will run the that spec.</p>

<p>Finally, if the plugin is invoked outside the context of any feature
or spec-related file, it will simply run the most recent test command
again.</p>

<p>Also, I&rsquo;ve added a mapping for <code>&lt;leader&gt;T</code> to run a more focused spec or
cucumber scenario. It works by adding the vim cursor&rsquo;s line number to
the rspec or cucumber command.</p>

<h2>Conclusion</h2>

<p>This setup has been really rewarding so far. There&rsquo;s far less context
switching, as I never have to leave my editor. There are also fewer
surprises. As far as I&rsquo;m concerned, the faster my feedback, the better.</p>

<p><em>Note:</em> You will probably want to use my fork of <a title="Joshua Davey's tslime.vim fork" href="https://github.com/jgdavey/tslime.vim">tslime.vim</a>, as the main
repository has some outstanding bugs, and the fixes have yet to been
merged in.</p>

<h2>Bonus</h2>

<p>See the plugin in action. If the video is hard to see, visit vimeo. There is a link to download at full size.</p>

<iframe src="http://player.vimeo.com/video/34879707?title=0&amp;byline=0&amp;portrait=0" width="500" height="306" frameborder="0" ></iframe>

</div>
</div>
</div>
</div>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(["_setAccount", "UA-330362-1"]);
  _gaq.push(["_trackPageview"]);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
